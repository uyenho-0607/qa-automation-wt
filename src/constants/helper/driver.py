from __future__ import annotations

import time

from selenium.webdriver.remote.webdriver import WebDriver
from selenium.webdriver.support.wait import WebDriverWait
from selenium.webdriver.support import expected_conditions as EC

from constants.helper.element import spinner_element
from constants.main import DRIVER_WAIT_DURATION


"""
---------------------------------------------------------------------------------------------------------------------------------------------------- 
                                                ACCESS URL
---------------------------------------------------------------------------------------------------------------------------------------------------- 
"""

def access_url(driver: WebDriver, url: str) -> None:
    # Route browser to the specified URL
    driver.get(url)

"""
---------------------------------------------------------------------------------------------------------------------------------------------------- 
                                                GET CURRENT URL
---------------------------------------------------------------------------------------------------------------------------------------------------- 
"""

def get_current_url(driver: WebDriver) -> str:
   return driver.current_url

"""
---------------------------------------------------------------------------------------------------------------------------------------------------- 
---------------------------------------------------------------------------------------------------------------------------------------------------- 
"""


"""
---------------------------------------------------------------------------------------------------------------------------------------------------- 
                                                WAIT FOR URL CHANGE
---------------------------------------------------------------------------------------------------------------------------------------------------- 
"""

def url_changes(driver: WebDriver) -> None:
    # Store the initial URL
    initial_url = driver.current_url
    
    # Print the initial and redirected URLs
    print("Initial URL:", initial_url)
    
    # Wait for the URL to change
    new_url = WebDriverWait(driver, 10).until(EC.url_changes(initial_url))
    
    current_url = get_current_url(driver)

    # Optionally, compare the URLs
    if initial_url != new_url:
        print("Redirected to:", current_url)
    else:
        assert False, "The URL has not changed."
        
    return new_url, current_url

"""
---------------------------------------------------------------------------------------------------------------------------------------------------- 
---------------------------------------------------------------------------------------------------------------------------------------------------- 
"""


"""
---------------------------------------------------------------------------------------------------------------------------------------------------- 
                                                WAIT FOR URL CHANGE
---------------------------------------------------------------------------------------------------------------------------------------------------- 
"""

def wait_for_url(driver, success_urls):

    spinner_element(driver)
    
    initial_url = driver.current_url  # Get the initial URL to detect changes
    
    try:
        WebDriverWait(driver, timeout=2).until(lambda d: d.current_url != initial_url or d.current_url in success_urls)
        
        # URL has changed or matched
        if driver.current_url in success_urls:
            return driver.current_url  # Return the matched URL
        else:
            return False  # URL changed but did not match success URLs
    except:
        return False  # Timeout or no URL change

"""
---------------------------------------------------------------------------------------------------------------------------------------------------- 
---------------------------------------------------------------------------------------------------------------------------------------------------- 
"""


"""
---------------------------------------------------------------------------------------------------------------------------------------------------- 
                                                WAIT
---------------------------------------------------------------------------------------------------------------------------------------------------- 
"""

# WebDriver instance polls the HTML DOM for a certain duration when trying to find any element.
# This is used when certain elements on the webpage are not available immediately and need some time to load.
def wait(driver: WebDriver, duration: int | None = None) -> None:
    wait_duration = duration if duration is not None else DRIVER_WAIT_DURATION
    driver.implicitly_wait(wait_duration)

"""
---------------------------------------------------------------------------------------------------------------------------------------------------- 
---------------------------------------------------------------------------------------------------------------------------------------------------- 
"""


"""
---------------------------------------------------------------------------------------------------------------------------------------------------- 
                                                DELAY
---------------------------------------------------------------------------------------------------------------------------------------------------- 
"""

# Adds delay of code execution using python's time plugin
def delay(duration: int) -> None:
    time.sleep(duration)

"""
---------------------------------------------------------------------------------------------------------------------------------------------------- 
---------------------------------------------------------------------------------------------------------------------------------------------------- 
"""



"""
---------------------------------------------------------------------------------------------------------------------------------------------------- 
                                                SWITCH TO NEW WINDOW
---------------------------------------------------------------------------------------------------------------------------------------------------- 
"""

# If new browser window is spawned, this function helps to switch focus onto the newly spawned browser window
def switch_to_new_window(driver) -> None:
    driver.switch_to.window(driver.window_handles[1])

"""
---------------------------------------------------------------------------------------------------------------------------------------------------- 
---------------------------------------------------------------------------------------------------------------------------------------------------- 
"""


"""
---------------------------------------------------------------------------------------------------------------------------------------------------- 
                                                WAIT FOR PAGE LOAD
---------------------------------------------------------------------------------------------------------------------------------------------------- 
"""

def wait_for_page_load(driver, duration: int | None = None):
    wait_duration = wait(duration)
    WebDriverWait(driver, wait_duration).until(lambda d: d.execute_script("return document.readyState") == "complete")

"""
---------------------------------------------------------------------------------------------------------------------------------------------------- 
---------------------------------------------------------------------------------------------------------------------------------------------------- 
"""


"""
---------------------------------------------------------------------------------------------------------------------------------------------------- 
                                                SHUT DOWN
---------------------------------------------------------------------------------------------------------------------------------------------------- 
"""

def shutdown(driver: WebDriver) -> None:
    driver.quit()
    
"""
---------------------------------------------------------------------------------------------------------------------------------------------------- 
---------------------------------------------------------------------------------------------------------------------------------------------------- 
"""
